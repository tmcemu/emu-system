x-logging: &default-logging
    driver: "json-file"
    options:
        max-size: "10m"
        max-file: "3"

networks:
    net:
        name: net
        external: true  # Создается в docker-compose.db.yml

services:
    emu-otel-collector:
        image: otel/opentelemetry-collector-contrib:latest
        container_name: "${EMU_OTEL_COLLECTOR_CONTAINER_NAME}"
        volumes:
            - "/var/lib/docker/containers:/var/lib/docker/containers:ro"
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
            - "/var/log:/var/log:ro"
            - "../${EMU_OTEL_COLLECTOR_CONFIG_FILE}:/etc/otel-collector/otel-collector.yaml:ro"
        ports:
            - "${EMU_OTEL_COLLECTOR_GRPC_PORT}:${EMU_OTEL_COLLECTOR_GRPC_PORT}"
            - "${EMU_OTEL_COLLECTOR_HTTP_PORT}:${EMU_OTEL_COLLECTOR_HTTP_PORT}"
            - "8888:8888"   # Prometheus metrics exposed by the collector
            - "8889:8889"   # Prometheus exporter metrics
            - "13133:13133" # health_check extension
            - "55679:55679" # zpages extension
        command: "--config=/etc/otel-collector/otel-collector.yaml"
        logging: *default-logging
        restart: unless-stopped
        networks:
            - net

    emu-grafana:
        image: grafana/grafana:latest
        container_name: "${EMU_GRAFANA_CONTAINER_NAME}"
        volumes:
            - "../${EMU_GRAFANA_VOLUME_DIR}:/var/lib/grafana"
            - "../${EMU_GRAFANA_DATASOURCES}:/etc/grafana/provisioning/datasources/datasources.yaml"
            - "../monitoring/grafana/alerting:/etc/grafana/provisioning/alerting"
        ports:
            - "${EMU_GRAFANA_PORT}:3000"
        environment:
            GF_AUTH_ANONYMOUS_ENABLED: false
            GF_SECURITY_ADMIN_USER: "${EMU_GRAFANA_ADMIN_LOGIN}"
            GF_SECURITY_ADMIN_PASSWORD: "${EMU_GRAFANA_ADMIN_PASSWORD}"
            GF_SECURITY_CSRF_TRUSTED_ORIGINS: "${EMU_DOMAIN},localhost"
            GF_SERVER_DOMAIN: "${EMU_DOMAIN}"
            GF_SERVER_ROOT_URL: "https://${EMU_DOMAIN}/grafana"
        networks:
            - net

    emu-node-exporter:
        image: prom/node-exporter:latest
        container_name: "${EMU_NODE_EXPORTER_CONTAINER_NAME}"
        restart: unless-stopped
        volumes:
            - "/proc:/host/proc:ro"
            - "/sys:/host/sys:ro"
            - "/:/rootfs:ro"
        command:
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--path.rootfs=/rootfs'
            - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|var/lib/docker/.+|var/lib/kubelet/.+)($$|/)'
            - '--collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$$'
        logging: *default-logging
        networks:
            - net

    emu-cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        container_name: "${EMU_CADVISOR_CONTAINER_NAME}"
        volumes:
            - "/:/rootfs:ro"
            - "/var/run:/var/run:ro"
            - "/sys:/sys:ro"
            - "/var/lib/docker/:/var/lib/docker:ro"
            - "/dev/disk/:/dev/disk:ro"
        ports:
            - "${VTBAIHR_CADVISOR_PORT}:8080"
        command:
            - '--housekeeping_interval=10s'
            - '--docker_only=true'
        privileged: true
        devices:
            - "/dev/kmsg:/dev/kmsg"
        logging: *default-logging
        restart: unless-stopped
        networks:
            - net